<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Son Defter</title>
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 10px;
    }
    .container { max-width: 1400px; margin: 0 auto; padding: 10px; }
    .header {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(10px);
      color: #2c3e50;
      padding: 20px 30px;
      margin-bottom: 20px;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }
    .header h1 { font-size: 24px; font-weight: 700; }
    .header-actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .btn-primary { background: #667eea; color: white; }
    .btn-primary:hover { background: #5568d3; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102,126,234,0.4); }
    .btn-success { background: #10b981; color: white; }
    .btn-success:hover { background: #059669; transform: translateY(-2px); }
    .btn-danger { background: #ef4444; color: white; }
    .btn-danger:hover { background: #dc2626; transform: translateY(-2px); }
    .btn-secondary { background: #6b7280; color: white; }
    .btn-info { background: #8b5cf6; color: white; }
    .btn-info:hover { background: #7c3aed; transform: translateY(-2px); }
    .secret-url-box { background: #f8fafc; padding: 15px; border-radius: 8px; border: 2px dashed #cbd5e1; margin-top: 15px; }
    .secret-url-box input { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 12px; background: white; }
    .tabs-container {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(10px);
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .tabs-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
    .tabs-header h2 { font-size: 18px; color: #2c3e50; font-weight: 600; }
    .tab-list { list-style: none; display: flex; gap: 10px; flex-wrap: wrap; }
    .tab-item {
      padding: 12px 20px;
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.3s;
      border: 2px solid transparent;
    }
    .tab-item:hover { background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%); transform: translateY(-2px); }
    .tab-item.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: rgba(255,255,255,0.3);
      box-shadow: 0 4px 12px rgba(102,126,234,0.3);
    }
    .tab-item .delete-btn { background: transparent; border: none; color: inherit; cursor: pointer; font-size: 18px; padding: 0; opacity: 0.7; }
    .tab-item .delete-btn:hover { opacity: 1; }
    .main-content { display: flex; gap: 20px; flex-wrap: wrap; }
    .sidebar {
      width: 100%;
      max-width: 280px;
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(10px);
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }
    .page-list { list-style: none; }
    .page-item {
      padding: 12px 15px;
      margin: 8px 0;
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      border-radius: 10px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s;
      border: 2px solid transparent;
    }
    .page-item:hover { background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%); transform: translateX(5px); }
    .page-item.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: rgba(255,255,255,0.3);
    }
    .content-area {
      flex: 1;
      min-width: 300px;
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(10px);
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }
    .entry-list { display: flex; flex-direction: column; gap: 15px; }
    .entry-card {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      padding: 20px;
      border-radius: 12px;
      border-left: 4px solid #667eea;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .entry-card:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
    .entry-card h3 { margin-bottom: 10px; font-size: 18px; color: #1e293b; font-weight: 600; }
    .entry-card .meta { font-size: 12px; color: #64748b; margin-bottom: 10px; }
    .entry-card .actions { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; font-size: 14px; }
    .form-group input, .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
      font-family: inherit;
    }
    .form-group input:focus, .form-group textarea:focus { outline: none; border-color: #667eea; }
    .form-group textarea { min-height: 200px; }
    #editor {
      height: 350px;
      background: white;
      border-radius: 8px;
      border: 2px solid #e2e8f0;
    }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 1000; padding: 20px; }
    .modal.active { display: flex; justify-content: center; align-items: center; }
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 16px;
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
    .modal-header h2 { color: #1e293b; font-weight: 600; }
    .close { cursor: pointer; font-size: 28px; color: #64748b; transition: color 0.3s; line-height: 1; }
    .close:hover { color: #1e293b; }
    .checkbox-group { display: flex; align-items: center; gap: 10px; }
    .checkbox-group input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
    .hidden { display: none; }
    .section-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
    .section-title h2 { font-weight: 600; color: #1e293b; }

    @media (max-width: 768px) {
      body { padding: 5px; }
      .container { padding: 5px; }
      .header { padding: 15px; }
      .header h1 { font-size: 20px; }
      .header-actions { width: 100%; justify-content: center; }
      .btn { padding: 8px 16px; font-size: 13px; }
      .main-content { flex-direction: column; }
      .sidebar { max-width: 100%; }
      .modal-content { padding: 20px; }
      .tabs-container { padding: 15px; }
      #editor { height: 250px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìî Son Defter - Admin Panel</h1>
      <div class="header-actions">
        <button class="btn btn-info" onclick="showSecretUrl()">üîó Gizli URL</button>
        <button class="btn btn-success" onclick="checkin()">‚úì Check-in</button>
        <button class="btn btn-secondary" onclick="logout()">√áƒ±kƒ±≈ü</button>
      </div>
    </div>

    <div class="tabs-container">
      <div class="tabs-header">
        <h2>üìë Sekmeler</h2>
        <button class="btn btn-primary" onclick="showAddTabModal()">+ Yeni Sekme</button>
      </div>
      <ul class="tab-list" id="tabList"></ul>
    </div>

    <div class="main-content">
      <div class="sidebar">
        <div class="section-title">
          <h2>üìÑ Sayfalar</h2>
          <button class="btn btn-primary" onclick="showAddPageModal()">+</button>
        </div>
        <ul class="page-list" id="pageList"></ul>
      </div>

      <div class="content-area">
        <div class="section-title">
          <h2>üìù G√ºnl√ºk Girdileri</h2>
          <button class="btn btn-primary" onclick="showAddEntryModal()">+ Yeni Girdi</button>
        </div>
        <div class="entry-list" id="entryList"></div>
      </div>
    </div>
  </div>

  <!-- Add Tab Modal -->
  <div class="modal" id="addTabModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Yeni Sekme</h2>
        <span class="close" onclick="closeModal('addTabModal')">&times;</span>
      </div>
      <div class="form-group">
        <label>Sekme Adƒ±</label>
        <input type="text" id="tabName" placeholder="Sekme adƒ±...">
      </div>
      <button class="btn btn-primary" onclick="addTab()">Ekle</button>
    </div>
  </div>

  <!-- Add Page Modal -->
  <div class="modal" id="addPageModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Yeni Sayfa</h2>
        <span class="close" onclick="closeModal('addPageModal')">&times;</span>
      </div>
      <div class="form-group">
        <label>Sayfa Adƒ±</label>
        <input type="text" id="pageName" placeholder="Sayfa adƒ±...">
      </div>
      <button class="btn btn-primary" onclick="addPage()">Ekle</button>
    </div>
  </div>

  <!-- Add/Edit Entry Modal -->
  <div class="modal" id="entryModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="entryModalTitle">Yeni Girdi</h2>
        <span class="close" onclick="closeModal('entryModal')">&times;</span>
      </div>
      <div class="form-group">
        <label>Ba≈ülƒ±k</label>
        <input type="text" id="entryTitle" placeholder="Ba≈ülƒ±k...">
      </div>
      <div class="form-group">
        <label>ƒ∞√ßerik</label>
        <div id="editor"></div>
      </div>
      <div class="form-group checkbox-group">
        <input type="checkbox" id="entryPublic">
        <label for="entryPublic">Herkese a√ßƒ±k</label>
      </div>
      <button class="btn btn-primary" onclick="saveEntry()">Kaydet</button>
    </div>
  </div>

  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <script>
    const API_URL = 'http://localhost:3000/api';
    let token = localStorage.getItem('token');
    let selectedTabId = null;
    let selectedPageId = null;
    let editingEntryId = null;
    let quill = null;

    if (!token) {
      window.location.href = '/login.html';
    }

    // Initialize Quill editor
    document.addEventListener('DOMContentLoaded', () => {
      quill = new Quill('#editor', {
        theme: 'snow',
        placeholder: 'G√ºnl√ºk i√ßeriƒüi yazƒ±n...',
        modules: {
          toolbar: {
            container: [
              [{ 'header': [1, 2, 3, false] }],
              ['bold', 'italic', 'underline', 'strike'],
              [{ 'list': 'ordered'}, { 'list': 'bullet' }],
              [{ 'color': [] }, { 'background': [] }],
              ['link', 'image', 'blockquote', 'code-block'],
              ['clean']
            ],
            handlers: {
              image: imageHandler
            }
          }
        }
      });
    });

    function imageHandler() {
      const input = document.createElement('input');
      input.setAttribute('type', 'file');
      input.setAttribute('accept', 'image/*');
      input.click();

      input.onchange = async () => {
        const file = input.files[0];
        if (file) {
          const formData = new FormData();
          formData.append('image', file);

          try {
            const response = await fetch(`${API_URL}/upload-image`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`
              },
              body: formData
            });

            const data = await response.json();
            if (response.ok) {
              const range = quill.getSelection();
              quill.insertEmbed(range.index, 'image', data.url);
            } else {
              alert('Resim y√ºklenemedi: ' + data.error);
            }
          } catch (error) {
            alert('Resim y√ºklenirken hata olu≈ütu');
          }
        }
      };
    }

    async function apiCall(endpoint, method = 'GET', body = null) {
      const options = {
        method,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        }
      };
      if (body) options.body = JSON.stringify(body);

      const response = await fetch(API_URL + endpoint, options);
      if (response.status === 401) {
        logout();
        return;
      }
      return response.json();
    }

    async function checkin() {
      await apiCall('/checkin', 'POST');
      alert('Check-in ba≈üarƒ±lƒ±! G√ºnl√ºk 30 g√ºn daha √∂zel kalacak.');
    }

    async function showSecretUrl() {
      const data = await apiCall('/secret-url');
      const url = data.url;
      const modal = document.createElement('div');
      modal.className = 'modal active';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h2>Gizli Check-in URL</h2>
            <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
          </div>
          <p>Bu URL'yi tarayƒ±cƒ±nƒ±za kaydedin. Herhangi bir cihazdan bu URL'yi ziyaret ederek check-in yapabilirsiniz.</p>
          <div class="secret-url-box">
            <input type="text" value="${url}" readonly onclick="this.select()">
          </div>
          <button class="btn btn-primary" style="margin-top: 15px;" onclick="navigator.clipboard.writeText('${url}'); alert('URL kopyalandƒ±!')">üìã Kopyala</button>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function logout() {
      localStorage.removeItem('token');
      window.location.href = '/login.html';
    }

    async function loadTabs() {
      const tabs = await apiCall('/tabs');
      const tabList = document.getElementById('tabList');
      tabList.innerHTML = '';
      tabs.forEach((tab, index) => {
        const li = document.createElement('li');
        li.className = 'tab-item' + (tab.id === selectedTabId ? ' active' : '');
        li.innerHTML = `
          <span onclick="selectTab(${tab.id})" style="flex: 1;">${tab.name}</span>
          <button class="delete-btn" onclick="event.stopPropagation(); deleteTab(${tab.id})">√ó</button>
        `;
        tabList.appendChild(li);
      });
    }

    async function selectTab(tabId) {
      selectedTabId = tabId;
      selectedPageId = null;
      await loadTabs();
      await loadPages(tabId);
      document.getElementById('entryList').innerHTML = '<p>Girdi g√∂r√ºnt√ºlemek i√ßin bir sayfa se√ßin.</p>';
    }

    async function loadPages(tabId) {
      const pages = await apiCall(`/pages/${tabId}`);
      const pageList = document.getElementById('pageList');
      pageList.innerHTML = '';
      pages.forEach((page, index) => {
        const li = document.createElement('li');
        li.className = 'page-item' + (page.id === selectedPageId ? ' active' : '');
        li.innerHTML = `
          <span onclick="selectPage(${page.id})">${page.name}</span>
          <button class="btn btn-danger" style="padding: 5px 10px;" onclick="deletePage(${page.id})">√ó</button>
        `;
        pageList.appendChild(li);
      });

      // Auto-select first page
      if (pages.length > 0 && !selectedPageId) {
        selectPage(pages[0].id);
      }
    }

    async function selectPage(pageId) {
      selectedPageId = pageId;
      await loadPages(selectedTabId);
      await loadEntries(pageId);
    }

    async function loadEntries(pageId) {
      const entries = await apiCall(`/entries/${pageId}`);
      const entryList = document.getElementById('entryList');
      entryList.innerHTML = '';
      entries.forEach(entry => {
        const div = document.createElement('div');
        div.className = 'entry-card';
        // Strip HTML tags for preview
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = entry.content;
        const textContent = tempDiv.textContent || tempDiv.innerText || '';

        div.innerHTML = `
          <h3>${entry.title}</h3>
          <div class="meta">${new Date(entry.created_at).toLocaleString('tr-TR')} ‚Ä¢ ${entry.is_public ? 'üåê Herkese A√ßƒ±k' : 'üîí √ñzel'}</div>
          <p>${textContent.substring(0, 200)}${textContent.length > 200 ? '...' : ''}</p>
          <div class="actions">
            <button class="btn btn-primary" onclick="editEntry(${entry.id})">D√ºzenle</button>
            <button class="btn btn-danger" onclick="deleteEntry(${entry.id})">Sil</button>
          </div>
        `;
        entryList.appendChild(div);
      });
    }

    function showAddTabModal() {
      document.getElementById('tabName').value = '';
      document.getElementById('addTabModal').classList.add('active');
    }

    function showAddPageModal() {
      if (!selectedTabId) {
        alert('√ñnce bir sekme se√ßin!');
        return;
      }
      document.getElementById('pageName').value = '';
      document.getElementById('addPageModal').classList.add('active');
    }

    function showAddEntryModal() {
      if (!selectedPageId) {
        alert('√ñnce bir sayfa se√ßin!');
        return;
      }
      editingEntryId = null;
      document.getElementById('entryModalTitle').textContent = 'Yeni Girdi';
      document.getElementById('entryTitle').value = '';
      if (quill) quill.root.innerHTML = '';
      document.getElementById('entryPublic').checked = false;
      document.getElementById('entryModal').classList.add('active');
    }

    async function editEntry(entryId) {
      const entries = await apiCall(`/entries/${selectedPageId}`);
      const entry = entries.find(e => e.id === entryId);
      if (!entry) return;

      editingEntryId = entryId;
      document.getElementById('entryModalTitle').textContent = 'Girdiyi D√ºzenle';
      document.getElementById('entryTitle').value = entry.title;
      if (quill) quill.root.innerHTML = entry.content;
      document.getElementById('entryPublic').checked = entry.is_public;
      document.getElementById('entryModal').classList.add('active');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    async function addTab() {
      const name = document.getElementById('tabName').value;
      if (!name) return;

      const tabs = await apiCall('/tabs');
      await apiCall('/tabs', 'POST', { name, position: tabs.length });
      closeModal('addTabModal');
      loadTabs();
    }

    async function addPage() {
      const name = document.getElementById('pageName').value;
      if (!name) return;

      const pages = await apiCall(`/pages/${selectedTabId}`);
      await apiCall('/pages', 'POST', { tab_id: selectedTabId, name, position: pages.length });
      closeModal('addPageModal');
      loadPages(selectedTabId);
    }

    async function saveEntry() {
      const title = document.getElementById('entryTitle').value;
      const content = quill ? quill.root.innerHTML : '';
      const is_public = document.getElementById('entryPublic').checked ? 1 : 0;

      if (!title || !content || content === '<p><br></p>') {
        alert('L√ºtfen ba≈ülƒ±k ve i√ßerik girin!');
        return;
      }

      if (editingEntryId) {
        await apiCall(`/entries/${editingEntryId}`, 'PUT', { title, content, is_public });
      } else {
        await apiCall('/entries', 'POST', { page_id: selectedPageId, title, content, is_public });
      }

      closeModal('entryModal');
      loadEntries(selectedPageId);
    }

    async function deleteTab(tabId) {
      if (!confirm('Bu sekmeyi ve i√ßindeki t√ºm sayfalarƒ± silmek istediƒüinize emin misiniz?')) return;
      await apiCall(`/tabs/${tabId}`, 'DELETE');
      selectedTabId = null;
      selectedPageId = null;
      loadTabs();
      document.getElementById('pageList').innerHTML = '';
      document.getElementById('entryList').innerHTML = '';
    }

    async function deletePage(pageId) {
      if (!confirm('Bu sayfayƒ± ve i√ßindeki t√ºm girdileri silmek istediƒüinize emin misiniz?')) return;
      await apiCall(`/pages/${pageId}`, 'DELETE');
      selectedPageId = null;
      loadPages(selectedTabId);
      document.getElementById('entryList').innerHTML = '';
    }

    async function deleteEntry(entryId) {
      if (!confirm('Bu girdiyi silmek istediƒüinize emin misiniz?')) return;
      await apiCall(`/entries/${entryId}`, 'DELETE');
      loadEntries(selectedPageId);
    }

    async function initializeAdmin() {
      const tabs = await apiCall('/tabs');
      await loadTabs();

      // Auto-select first tab if available
      if (tabs.length > 0 && !selectedTabId) {
        await selectTab(tabs[0].id);
      }
    }

    initializeAdmin();
  </script>
</body>
</html>
